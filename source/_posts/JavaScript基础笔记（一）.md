---
title: JavaScript æ‰§è¡ŒæœŸä¸Šä¸‹æ–‡ & é—­åŒ…
date: 2025.9.1
---
## ä¸€ã€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆExecution Contextï¼‰

JavaScript æ‰§è¡Œä»£ç æ—¶ï¼Œä¼šä¸ºæ¯ä¸€æ®µå¯æ‰§è¡Œä»£ç åˆ›å»ºä¸€ä¸ª **æ‰§è¡Œä¸Šä¸‹æ–‡**ï¼Œå®ƒæ˜¯ä»£ç è¿è¡Œçš„â€œç¯å¢ƒâ€ã€‚

### ä¸‰ç§ç±»å‹

1. **å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡**ï¼šè„šæœ¬å¯åŠ¨æ—¶åˆ›å»ºï¼Œå…¨å±€ä½œç”¨åŸŸã€‚
2. **å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡**ï¼šæ¯æ¬¡è°ƒç”¨å‡½æ•°æ—¶åˆ›å»ºã€‚
3. **eval æ‰§è¡Œä¸Šä¸‹æ–‡**ï¼š`eval` ä¸­æ‰§è¡Œä»£ç æ—¶åˆ›å»ºï¼ˆä¸å¸¸ç”¨ï¼‰ã€‚

### æ‰§è¡Œä¸Šä¸‹æ–‡çš„ç»“æ„

æ¯ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡åœ¨è¿è¡Œæ—¶åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼š

| ç»„ä»¶ | è¯´æ˜ |
|------|------|
| **LexicalEnvironment** | å½“å‰ä¸Šä¸‹æ–‡çš„è¯æ³•ç¯å¢ƒï¼ˆç®¡ç† `let`/`const`ï¼‰ |
| **VariableEnvironment** | å½“å‰ä¸Šä¸‹æ–‡çš„å˜é‡ç¯å¢ƒï¼ˆç®¡ç† `var`/å‡½æ•°å£°æ˜ï¼‰ |
| **ThisBinding** | `this` çš„å€¼ |

> âœ… ç®€è®°ï¼š**æ‰§è¡Œä¸Šä¸‹æ–‡ = è¯æ³•ç¯å¢ƒ + å˜é‡ç¯å¢ƒ + this**

---

## äºŒã€è¯æ³•ç¯å¢ƒ vs å˜é‡ç¯å¢ƒ

| åç§° | è´Ÿè´£ | ç‰¹ç‚¹ |
|------|------|------|
| **LexicalEnvironment** | `let`ã€`const` | æœ‰å—çº§ä½œç”¨åŸŸï¼Œæœ‰â€œæš‚æ—¶æ€§æ­»åŒºâ€ï¼ˆTDZï¼‰ |
| **VariableEnvironment** | `var`ã€å‡½æ•°å£°æ˜ | æœ‰å˜é‡æå‡ï¼Œæ— å—çº§ä½œç”¨åŸŸ |

> âš ï¸ æ³¨æ„ï¼šå‡½æ•°å¼€å§‹æ‰§è¡Œæ—¶ï¼Œ`LexicalEnvironment` å’Œ `VariableEnvironment` é€šå¸¸ç›¸åŒï¼Œä½†åç»­å¯èƒ½åˆ†ç¦»ï¼ˆå¦‚ `eval`ï¼‰ã€‚

---

## ä¸‰ã€è¯æ³•ç¯å¢ƒï¼ˆLexical Environmentï¼‰çš„å†…éƒ¨ç»“æ„

æ¯ä¸ªè¯æ³•ç¯å¢ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç»“æ„ï¼ŒåŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š

| éƒ¨åˆ† | è¯´æ˜ |
|------|------|
| **Environment Record** | å­˜å‚¨å˜é‡å’Œå‡½æ•°å£°æ˜çš„å®é™…ä½ç½®ï¼ˆå¦‚å¯¹è±¡ç¯å¢ƒè®°å½•ã€å£°æ˜æ€§ç¯å¢ƒè®°å½•ï¼‰ |
| **Outer Environment Reference** | æŒ‡å‘**å¤–å±‚è¯æ³•ç¯å¢ƒ**çš„å¼•ç”¨ï¼Œå½¢æˆä½œç”¨åŸŸé“¾ |

> âœ… ä½œç”¨åŸŸé“¾ = é€šè¿‡ `Outer` ä¸€çº§ä¸€çº§å‘ä¸ŠæŸ¥æ‰¾

---

## å››ã€å‡½æ•°çš„å†…éƒ¨å±æ€§ï¼š`[[Environment]]`

- **å®šä¹‰**ï¼šå‡½æ•°å¯¹è±¡çš„ä¸€ä¸ª**å†…éƒ¨æ§½ï¼ˆInternal Slotï¼‰**
- **åˆ›å»ºæ—¶æœº**ï¼šå‡½æ•°**å®šä¹‰æ—¶**è‡ªåŠ¨åˆ›å»º
- **å€¼**ï¼šæŒ‡å‘å‡½æ•°**å®šä¹‰æ—¶æ‰€å¤„çš„è¯æ³•ç¯å¢ƒ**
- **ä½œç”¨**ï¼šå®ç°é—­åŒ…å’Œè¯æ³•ä½œç”¨åŸŸçš„æ ¸å¿ƒ

```js
function outer() {
    let x = 10;
    function inner() { console.log(x); }
    // inner.[[Environment]] = outer çš„è¯æ³•ç¯å¢ƒ
}
```

> âœ… `[[Environment]]` æ˜¯å‡½æ•°çš„â€œå‡ºç”Ÿåœ°è®°å¿†â€

---

## äº”ã€`Outer Environment Reference` æ˜¯è°åˆå§‹åŒ–çš„ï¼Ÿ

> **å…³é”®é—®é¢˜ï¼šè¯æ³•ç¯å¢ƒçš„ `Outer` ä»å“ªæ¥ï¼Ÿ**

### âœ… ç­”æ¡ˆ

`Outer Environment Reference` æ˜¯åœ¨**åˆ›å»ºè¯æ³•ç¯å¢ƒæ—¶**ï¼Œç”± JavaScript å¼•æ“æ ¹æ®ä»¥ä¸‹è§„åˆ™è‡ªåŠ¨è®¾ç½®ï¼š

| åœºæ™¯ | `Outer` çš„æ¥æº |
|------|----------------|
| **å‡½æ•°è°ƒç”¨** | æ¥è‡ªå‡½æ•°çš„ `[[Environment]]` å±æ€§ |
| **å—çº§ä½œç”¨åŸŸ**ï¼ˆå¦‚ `if`ã€`for`ï¼‰ | æ¥è‡ªå½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡çš„è¯æ³•ç¯å¢ƒï¼ˆè¯æ³•åµŒå¥—ç»“æ„ï¼‰ |

### ğŸ¯ æ ¸å¿ƒæµç¨‹ï¼ˆå‡½æ•°è°ƒç”¨æ—¶ï¼‰

1. è°ƒç”¨å‡½æ•° `fn()`
2. åˆ›å»º `fn` çš„æ‰§è¡Œä¸Šä¸‹æ–‡
3. åˆ›å»º `fn.LexicalEnvironment`
4. è®¾ç½® `fn.LexicalEnvironment.Outer = fn.[[Environment]]`

> âœ… æ‰€ä»¥ï¼š`[[Environment]]` æ˜¯ `Outer` çš„â€œæºå¤´â€

---

## å…­ã€é—­åŒ…ï¼ˆClosureï¼‰

### 1. ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿ
>
> ä¸€ä¸ªå‡½æ•°èƒ½å¤Ÿè®¿é—®å…¶**å®šä¹‰æ—¶æ‰€åœ¨çš„ä½œç”¨åŸŸ**ä¸­çš„å˜é‡ï¼Œå³ä½¿è¯¥å‡½æ•°åœ¨å¤–éƒ¨æ‰§è¡Œã€‚

### 2. é—­åŒ…çš„å½¢æˆæ¡ä»¶

- å†…å±‚å‡½æ•°å¼•ç”¨äº†å¤–å±‚å‡½æ•°çš„å˜é‡
- å†…å±‚å‡½æ•°è¢«ä¼ é€’åˆ°å¤–å±‚å‡½æ•°ä¹‹å¤–ï¼ˆå¦‚è¿”å›ã€èµ‹å€¼ï¼‰

### 3. é—­åŒ…çš„æœ¬è´¨
>
> **é—­åŒ… = å‡½æ•° + å‡½æ•°çš„ `[[Environment]]` å¼•ç”¨**

### 4. ä¾‹å­

```js
function counter() {
    let count = 0;
    return function() {
        count++;
        return count;
    };
}
const inc = counter();
inc(); // 1
inc(); // 2 â†’ count è¢«é—­åŒ…ä¿ç•™
```

> ğŸ”— åŸå› ï¼š`inner.[[Environment]]` æŒ‡å‘ `counter` çš„è¯æ³•ç¯å¢ƒï¼Œ`count` ä¸ä¼šè¢«å›æ”¶ã€‚

---

## ä¸ƒã€this çš„æŒ‡å‘

| å‡½æ•°ç±»å‹ | this æŒ‡å‘ |
|--------|----------|
| **æ™®é€šå‡½æ•°** | è°è°ƒç”¨ï¼Œè°å°±æ˜¯ `this`<br>`obj.fn()` â†’ `this = obj` |
| **ç®­å¤´å‡½æ•°** | ç»§æ‰¿**å®šä¹‰æ—¶å¤–å±‚ä½œç”¨åŸŸçš„ `this`**<br>ï¼ˆæ²¡æœ‰è‡ªå·±çš„ `this`ï¼‰ |
| **å…¨å±€ç¯å¢ƒ** | æµè§ˆå™¨ï¼š`window`ï¼ŒNode.jsï¼š`global` |

> âœ… ç®­å¤´å‡½æ•°çš„ `this` æ˜¯è¯æ³•ç»‘å®šï¼Œæ™®é€šå‡½æ•°æ˜¯åŠ¨æ€ç»‘å®šã€‚

---

## å…«ã€å˜é‡æå‡ï¼ˆHoistingï¼‰

| å£°æ˜æ–¹å¼ | æ˜¯å¦æå‡ | åˆå§‹åŒ– | è®¿é—®æ—¶æœº |
|--------|----------|--------|---------|
| `var` | âœ… æ˜¯ | `undefined` | å£°æ˜å‰å¯è®¿é—® |
| `let` / `const` | âœ… å£°æ˜æå‡ | ä¸åˆå§‹åŒ–ï¼ˆTDZï¼‰ | å£°æ˜å‰è®¿é—®æŠ¥é”™ |

> âš ï¸ `let`/`const` ä¹Ÿæœ‰â€œæå‡â€ï¼Œä½†ä¸èƒ½åœ¨å£°æ˜å‰ä½¿ç”¨ï¼ˆæš‚æ—¶æ€§æ­»åŒºï¼‰ã€‚

---

## ä¹ã€æœªå£°æ˜å˜é‡

- `x = 10` â†’ è‡ªåŠ¨æˆä¸º**å…¨å±€å˜é‡**
- å­˜å‚¨ä½ç½®ï¼šå…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡
- åº”é¿å…ï¼Œé˜²æ­¢æ±¡æŸ“å…¨å±€

---

## åã€å¼€å‘è€…å·¥å…·ä¸­çš„è§‚å¯Ÿ

| æ¦‚å¿µ | æ˜¯å¦å¯åœ¨ä»£ç ä¸­è®¿é—® | æ˜¯å¦å¯åœ¨ DevTools ä¸­è§‚å¯Ÿ |
|------|------------------|------------------------|
| `[[Environment]]` | âŒ å¦ | âŒ å¦ |
| `[[Scopes]]` | âŒ å¦ | âœ… æ˜¯ï¼ˆChrome è°ƒè¯•ç”¨ï¼‰ |
| æ‰§è¡Œä¸Šä¸‹æ–‡ | âŒ å¦ | âœ… æ˜¯ï¼ˆScope é¢æ¿ï¼‰ |
| `this` | âœ… å¯é€šè¿‡ `console.log(this)` | âœ… æ˜¯ |

> ğŸ› ï¸ DevTools çš„ `[[Scopes]]` æ˜¯ `[[Environment]]` çš„è°ƒè¯•å¿«ç…§ã€‚

---

## ğŸ§© æ ¸å¿ƒå›¾è§£ï¼ˆæ–‡å­—ç‰ˆï¼‰

```
å‡½æ•°å®šä¹‰æ—¶ï¼š
    inner.[[Environment]] â†’ outer çš„è¯æ³•ç¯å¢ƒ

å‡½æ•°æ‰§è¡Œæ—¶ï¼š
    åˆ›å»º inner çš„æ‰§è¡Œä¸Šä¸‹æ–‡
        LexicalEnvironment:
            Environment Record: { d: 4 }
            Outer â†’ inner.[[Environment]] â†’ outer çš„è¯æ³•ç¯å¢ƒ
        VariableEnvironment: ...
        ThisBinding: ...

å˜é‡æŸ¥æ‰¾ï¼š
    inner â†’ outer â†’ å…¨å±€ â†’ æ‰¾ä¸åˆ° â†’ æŠ¥é”™
```

---

## âœ… æ€»ç»“

> - **å®šä¹‰æ—¶ç¡®å®šä½œç”¨åŸŸï¼Œè°ƒç”¨æ—¶ç¡®å®š this**
> - `var` æå‡ä¸º `undefined`ï¼Œ`let/const` æœ‰æš‚æ—¶æ€§æ­»åŒº
> - é—­åŒ…æ˜¯å‡½æ•° + `[[Environment]]`
> - `[[Environment]]` æ˜¯å‡½æ•°çš„ï¼Œ`Outer` æ˜¯è¯æ³•ç¯å¢ƒçš„
> - `Outer` çš„å€¼æ¥è‡ª `[[Environment]]`
> - ä½œç”¨åŸŸé“¾ = `Outer` è¿æˆçš„é“¾
> - æ‰§è¡Œä¸Šä¸‹æ–‡æœ‰ `LexicalEnvironment` å’Œ `VariableEnvironment`ï¼Œåˆ†å·¥æ˜ç¡®

---
